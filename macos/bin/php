#!/usr/bin/env bash

# We use this custom script here to also allow interactive shell sessions e.g. php
# invoked in JS scripts to use the correct isolated version.

DIR=$HOME/.composer/vendor/laravel/valet
PHP=/opt/homebrew/opt/php/bin/php

# Proxy PHP commands to the "php" executable on the isolated site
# We get the correct PHP executable for the site via valet.
# To prevent issues when PHP is updated and the extensions throw warnings, we disable error reporting for warnings.
# Otherwise, the output may contain warning messages and we want to get the path as the only output.
if [[ $1 == *"--site="* ]]; then
    SITE=${2#*=}
    if ! PHP_BIN=$($PHP -d error_reporting=1 "$DIR/cli/valet.php" which-php $SITE 2>/dev/null); then
        PHP_BIN=$PHP
    fi
    [ -z "$PHP_BIN" ] && PHP_BIN=$PHP
    $PHP_BIN "${@:2}"
else
    if ! PHP_BIN=$($PHP -d error_reporting=1 "$DIR/cli/valet.php" which-php 2>/dev/null); then
        PHP_BIN=$PHP
    fi
    [ -z "$PHP_BIN" ] && PHP_BIN=$PHP
    $PHP_BIN "${@:1}"
fi

exit
