#!/bin/sh

echo "\n > Upgrading brew packages...\n"
brew update
brew upgrade
# Fixes gnupg link conflicts with GPGSuite
brew unlink gnupg

echo "\n > Upgrading pecl packages...\n"
# Paths to openssl to build pecl extensions (swoole)
export PATH="${HOMEBREW_PREFIX}/opt/openssl@3/bin:$PATH"
export LDFLAGS="-L${HOMEBREW_PREFIX}/opt/openssl@3/lib"
export CPPFLAGS="-I${HOMEBREW_PREFIX}/opt/openssl@3/include"
export PKG_CONFIG_PATH="${HOMEBREW_PREFIX}/opt/openssl@3/lib/pkgconfig"

yes | pecl upgrade

echo "\n > Upgrading global composer packages...\n"
composer global upgrade

echo "\n > Running valet install...\n"
valet install

echo "\n > Applying Valet PHP fix for segfaults...\n"
sudo echo ";; these are an attempt to mitigate 502 errors caused by segfaults in upstream processes caused by krb5 v1.21 added in June 2023 to php's core build. Ref Issue #1433
; for gettext
env['LC_ALL'] = C
; for postgres
env['PGGSSENCMODE'] = disable

" >> ${HOMEBREW_PREFIX}/etc/php/8.2/php-fpm.d/valet-fpm.conf

echo "\n > Restarting Valet to apply patch...\n"
valet restart

echo "\n > Upgrading nvim packages...\n"
nvim +PlugUpgrade +PlugUpdate +qall

echo "\n > Upgrading znap plugins...\n"
znap-update
echo "\n"

echo "\n > Done ğŸš€ enjoy your day!\n"
